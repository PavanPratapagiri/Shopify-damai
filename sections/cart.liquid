<!-- /sections/cart.liquid -->
{%- liquid
  assign hide_quantity = 'quantity--hide'
  if settings.cart_show_quantity
    assign hide_quantity = ''
  endif

  assign ajax_disable = false
  assign no_ajax_class = ''
  if settings.cart_style == 'compatible'
    assign ajax_disable = true
    assign no_ajax_class = 'no--ajax'
  endif

  assign full_init = ''
  assign empty_init = 'cart--hidden'
  if cart.item_count == 0
    assign empty_init = ''
    assign full_init = 'cart--hidden'
  endif
-%}

<style>
  /* Loading state styles - Per item loading */
  .cart__items__row {
    position: relative;
    transition: opacity 0.2s ease;
  }
  
  .cart__items__row.updating {
    opacity: 0.7;
  }
  
  .cart__items__row.updating::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, #4CAF50, transparent);
    animation: loading-bar 1s ease-in-out infinite;
    z-index: 10;
  }
  
  @keyframes loading-bar {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  
  /* Global cart loading - minimal */
  .cart--loading {
    pointer-events: none;
  }
  
  /* Error message styles */
  .cart__error {
    background: #fee;
    color: #c33;
    padding: 12px 16px;
    border-radius: 4px;
    margin-bottom: 16px;
    display: none;
  }
  
  .cart__error.active {
    display: block;
    animation: slideIn 0.3s ease;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Smooth transitions */
  .cart__items__row {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  .cart__items__row.removing {
    opacity: 0;
    transform: translateX(-20px);
  }
  
  /* Disable quantity buttons during update */
  .quantity__wrapper.disabled {
    pointer-events: none;
    opacity: 0.6;
  }
  
  /* Volume Discount Display Styles */
  .volume-discount-info {
    background: #f0f8ff;
    border: 2px solid #4CAF50;
    border-radius: 8px;
    padding: 16px;
    margin: 16px 0;
    text-align: center;
  }
  
  .volume-discount-info.next-tier {
    background: #fff8e1;
    border-color: #FF9800;
  }
  
  .discount-badge {
    display: inline-block;
    background: #4CAF50;
    color: white;
    font-size: 24px;
    font-weight: bold;
    padding: 8px 20px;
    border-radius: 50px;
    margin-bottom: 8px;
  }
  
  .next-tier .discount-badge {
    background: #FF9800;
  }
  
  .discount-message {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-top: 8px;
  }
  
  /* Smooth number transitions */
  [data-cart-final], [data-line-total], [data-item-price] {
    transition: color 0.3s ease;
  }
  
  .price-updating {
    color: #4CAF50;
  }
</style>

<div class="cart__template {{ no_ajax_class }} {{ hide_quantity }} {{ section.settings.bg }}"
  data-cart-message-container
  data-section-id="{{ section.id }}"
  data-section-type="cart"
  data-ajax-disable="{{ ajax_disable }}"
  style="--PT: {{ section.settings.padding_top }}px; --PB: {{ section.settings.padding_bottom }}px;">
  
  <!-- Error message container -->
  <div class="cart__error" data-cart-error></div>
  
  {% comment %} Cart is empty {% endcomment %}
  <div class="cart__empty__page {{ empty_init }}" data-cart-empty>
    {% render 'cart-empty' %}
  </div>
  
  {% comment %} Cart is full {% endcomment %}
  <div class="{{ section.settings.width }} section-padding {{ full_init }}" data-cart-form data-cart-loading>
    <form action="{{ routes.cart_url }}" method="post" novalidate class="cart">
      <h3 class="cart__page__title body-size-8">{{ 'cart.general.title' | t }}</h3>
      <div class="errors" data-form-errors style="display: none;"></div>
      <div class="cart__items__grid cart__heading__wrapper">
        <div class="cart__heading__back">
          <a href="{{ settings.cart_continue_browsing | default: routes.all_products_collection_url }}" class="cart__heading cart__return">
            {% render 'icon-arrow-long-left' %}
            &nbsp;
            {{ 'cart.general.continue_browsing' | t }}
          </a>
        </div>
        <div class="cart__items__price">
          <p class="cart__heading">{{ 'cart.label.price' | t }}</p>
        </div>
        <div class="cart__items__quantity">
          <p class="cart__heading">{{ 'cart.label.quantity' | t }}</p>
        </div>
        <div class="cart__items__total">
          <p class="cart__heading">{{ 'cart.label.total' | t }}</p>
        </div>
      </div>
      <div class="template__cart__body">
        <div class="errors" data-form-errors style="display: none;"></div>
        <div data-cart-form>
            {% comment %}
              The following snippet is refreshed via ajax with
              cart.items.liquid when the quantity is adjusted.
            {% endcomment %}
            <div data-line-items>
            {% render 'cart-line-items',  wpddrawer: false %}
            </div>
        </div>

        <div class="template__cart__footer{% if additional_checkout_buttons and settings.cart_show_additional_buttons %} template__cart__footer--additional_buttons{% endif %}" data-cart-bottom>

          <div class="cart__footer__notes">
            {%- if settings.cart_notes_enable -%}
              <label class="cart__notes__label" for="CartSpecialInstructions">{{ 'cart.general.note' | t }}</label>
              <textarea name="note" class="input-full" id="CartSpecialInstructions" data-cart-note>{{ cart.note }}</textarea>
            {%- endif -%}
          </div>
          <div class="cart__footer__shipping">
            {%- if settings.cart_shipping_enable -%}
              {% render 'cart-shipping' %}
            {%- endif -%}
          </div>
          <div class="cart__footer__total">
            {% if settings.cart_custom_message_enable and settings.cart_custom_message_text != blank %}
              <div class="cart__message cart__message--custom">
                {{ settings.cart_custom_message_text }}
              </div>
            {% endif %}

            <div class="cart__page__shipping">
              {% assign free_shipping_text = block.settings.message | default: settings.message %}
{% assign is_enable = false %}
{% assign show_wheel = true %}

{% assign font_size_class = font_size_class | default: '' %}

{% if block.settings.show_wheel == false %}
  {% assign show_wheel = false %}
{% endif %}

{% if block.settings.message != blank %}
  {% assign is_enable = true %}
{% endif %}

{% if settings.show_free_shipping_message and settings.free_shipping_limit != blank and free_shipping_text != blank %}
  {% assign is_enable = true %}
{% endif %}

{% if is_enable %}
  {% assign limit = settings.free_shipping_limit | plus: 0 %}
  {% assign limit_currency = limit | times: 100 %}
  {% assign subtotal_without_currency = cart.total_price | plus: 0 | divided_by: 100 %}

  {% capture left_to_spend %}
    <span data-left-to-spend class="strong">
      {% if settings.currency_code_enable %}
        {{ limit_currency | minus: cart.total_price | money_with_currency }}
      {% else %}
        {{ limit_currency | minus: cart.total_price | money_without_trailing_zeros }}
      {% endif %}
    </span>
  {% endcapture %}

  {% assign free_shipping_message = free_shipping_text | replace: '||amount||', left_to_spend %}
  {% assign qualified_shipping_message = 'cart.general.qualified_shipping_message' | t %}
  {% assign class_message = '' %}

  {% if subtotal_without_currency >= limit %}
    {% if qualified_shipping_message != blank %}
      {% assign class_message = 'is-success' %}
    {% else %}
      {% assign class_message = 'is-hidden' %}
    {% endif %}
  {% elsif subtotal_without_currency == 0 %}
    {% comment %} {% assign class_message = 'is-hidden' %} {% endcomment %}
  {% endif %}

  <p class="cart__message {{ class_message }} {{ font_size_class }}" data-cart-message="{% if qualified_shipping_message != blank %}true{% else %}false{% endif %}" data-limit="{{ limit }}">
    {% if show_wheel %}
      {% assign percent = limit | minus: subtotal_without_currency | times: 100 | divided_by: limit %}
      {% assign percent = 100 | minus: percent %}

      {% if percent > 100 %}
        {% assign percent = 100 %}
      {% endif %}

      <small class="cart__graph">
        {% for i in (1..6) %}
          <small class="cart__graph-dot cart__graph-dot--{{ i }}"></small>
        {% endfor %}
        {%- assign stroke_dashoffset = '87.96459430051421' -%}
        {%- if settings.cart_style == 'compatible' -%}
          {%- assign math_pi = 3.14159265359 -%}
          {%- assign stroke_circumference = 28 | times: math_pi -%}
          {%- assign stroke_calculate = percent | times: stroke_circumference -%}
          {%- assign stroke_calculate = stroke_calculate | divided_by: 100 | divided_by: 2 -%}
          {%- assign stroke_dashoffset = stroke_circumference | minus: stroke_calculate -%}
        {%- endif -%}

        <svg height="18" width="18">
          <circle r="7" cx="9" cy="9" />
          <circle class="cart__graph-progress" stroke-dasharray="87.96459430051421 87.96459430051421" style="stroke-dashoffset: {{ stroke_dashoffset }}" data-cart-progress data-percent="{{ percent }}" r="7" cx="9" cy="9" />
        </svg>
      </small>
    {% endif %}

    {% if qualified_shipping_message != blank %}
      <span class="cart__message-success">{{ qualified_shipping_message }}</span>
    {% endif %}

    <span class="cart__message-default">
      {{ free_shipping_message }}
    </span>
  </p>
{% endif %}

            </div>

            <div class="page__footer__subtotal" data-cart-subtotal>
              {% render 'cart-subtotal' %}
            </div>

            <p>
              <span class="cart__footer__label">{{ 'cart.general.subtotal' | t }}</span>
              <span class="cart__footer__value wcp-original-cart-total" data-cart-final>
                {{ cart.total_price | money_with_currency }}
              </span>
            
            </p>
              <span class="cart__footer__value wcp-cart-total"></span>
                       <div class="additional-notes">
                          <span class="wcp-minimums-note"></span>
                          <span class="wcp-extra-note "></span>
                      </div>
                      {% render "wcp_multi_currency_msg" %}  
            
            <p class="cart__footer__small">{{ 'cart.general.shipping_at_checkout' | t }}</p>
          </div>

          <div class="cart__footer__checkout">

{% assign wcp_wholesale_customer = false %}
{% if shop.metafields.wcp_status.wcp_status != 'disabled' and customer %}
{% assign active_discounts = shop.metafields.wcp_active_discounts.wcp_active_discounts %}
{% assign active_discounts_array = active_discounts | split: ',' %}
{% assign customer_tags = blank %}
{% for tag in customer.tags %}
{% assign tempTag = tag | downcase %}
{% assign customer_tags = customer_tags | prepend:tempTag %}
{% unless forloop.last %}
{% assign customer_tags = customer_tags | prepend:','  %}
{% endunless %}
{% endfor %}
{% assign customer_tags = customer_tags | split:',' %}
{% assign active_discounts = active_discounts | downcase %}
{% for discount_key in active_discounts_array %}
{% assign key_split = discount_key | split: '-' %}
{% assign key_split_length = key_split | size %}
{% if key_split_length > 2 %}
{% assign removeable_key = key_split.last | prepend: '-' %}
{% assign wcp_customer_tag = discount_key | remove_last: removeable_key %}
{% else %}
{% assign wcp_customer_tag = key_split[0] %}
{% endif %}
{% assign wcp_customer_tag = wcp_customer_tag | downcase %}
{% if customer_tags contains wcp_customer_tag %}
{% assign wcp_wholesale_customer = true %}
{% endif %}
{% endfor %}
{% endif %}
{% if wcp_wholesale_customer == true %}
            <button type="submit" class="wcp_checkout_btn btn btn--primary btn--large checkout__button WPDcheckoutBTN" style="color:white; padding: 12px 20px; margin-bottom: 2px;" disabled>{{ 'cart.general.checkout' | t }}</button>
            <script>
              document.addEventListener("DOMContentLoaded", function(){
               var hidecheckoutBTN = setInterval(function(){
                if(window.wcp_data){
                	    document.getElementsByClassName("WPDcheckoutBTN")[0].removeAttribute("disabled");
                        clearInterval(hidecheckoutBTN);
            	}
                },100) // Reduced from 2500ms to 100ms check interval
                
              });  
            </script>   
  {% else %}            
            <button type="submit" name="checkout" class="btn btn--primary btn--large checkout__button">
              {{ 'cart.general.checkout' | t }}
            </button>
            {% endif %}
         </div>

          <div class="cart__footer__update">
            <span class="cart__update" data-update-button>
              <span class="cart__update__icon">{% render 'icon-sync' %}</span>
              <button type="submit" name="update" class="text-link">
                {{ 'cart.general.update' | t }}
              </button>
            </span>
          </div>

          {% if additional_checkout_buttons and settings.cart_show_additional_buttons %}
            <div class="cart__footer__additional">
              <div class="additional-checkout-buttons">
                {{ content_for_additional_checkout_buttons }}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
             <div>
                  {% if customer.tags contains "wpdnet" %}
                      {% if shop.metafields.wcp_net.isNetEnabled == "true" or shop.metafields.wcp_net.isNetEnabled == "1" %}
                          <div style="margin-top:30px;float:right;width: 23%;">
                              <p>{{shop.metafields.wcp_net.netCartMsg}}</p>
                              <a id="wcp-30-open" class="btn btn--primary btn--large" style="width:100%;cursor:pointer;">{{shop.metafields.wcp_net.netBtnMsg}}</a>
                          </div>
                      {% endif %}
                  {% endif %}
              </div>
    </form>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  // Configuration
  const CONFIG = {
    isWholesaleCustomer: {% if wcp_wholesale_customer == true %}true{% else %}false{% endif %},
    wcpDelay: 200, // Reduced significantly
    debounceDelay: 500, // Debounce for smoother updates
    optimisticUI: true, // Enable instant UI feedback
    maxRetries: 3,
    batchUpdates: true // Batch multiple updates together
  };
  
  // State management
  const state = {
    isUpdating: false,
    updateQueue: new Map(), // Use Map to merge duplicate updates
    pendingUpdates: new Map(),
    debounceTimers: new Map(),
    retryCount: 0,
    lastCart: null
  };
  
  // Cart Manager Class
  class CartManager {
    constructor() {
      this.errorContainer = document.querySelector('[data-cart-error]');
      this.cartLoading = document.querySelector('[data-cart-loading]');
      this.cartEmpty = document.querySelector('[data-cart-empty]');
      this.cartForm = document.querySelector('[data-cart-form]');
    }
    
    // Initialize cart
    init() {
      this.attachEventListeners();
      this.preventDefaultUpdate();
      this.cacheCurrentCart();
    }
    
    // Cache current cart state
    cacheCurrentCart() {
      fetch('/cart.js')
        .then(r => r.json())
        .then(cart => {
          state.lastCart = cart;
        })
        .catch(console.error);
    }
    
    // Attach all event listeners with delegation
    attachEventListeners() {
      document.addEventListener('click', this.handleClick.bind(this));
      document.addEventListener('change', this.handleChange.bind(this));
      document.addEventListener('input', this.handleInput.bind(this));
    }
    
    // Handle all click events
    handleClick(e) {
      const plusBtn = e.target.closest('.quantity__button--plus');
      const minusBtn = e.target.closest('.quantity__button--minus');
      const removeBtn = e.target.closest('[data-remove-key]');
      const checkoutBtn = e.target.closest('.checkout__button');
      
      if (checkoutBtn) return;
      
      if (plusBtn) {
        e.preventDefault();
        this.adjustQuantity(plusBtn, 1);
      } else if (minusBtn) {
        e.preventDefault();
        this.adjustQuantity(minusBtn, -1);
      } else if (removeBtn) {
        e.preventDefault();
        const key = removeBtn.getAttribute('data-remove-key');
        this.removeItem(key);
      }
    }
    
    // Handle change events
    handleChange(e) {
      const qtyInput = e.target.closest('.quantity__input');
      if (qtyInput) {
        const key = qtyInput.getAttribute('data-update-cart');
        const newQty = parseInt(qtyInput.value) || 0;
        this.scheduleUpdate(key, newQty);
      }
    }
    
    // Handle input events
    handleInput(e) {
      const qtyInput = e.target.closest('.quantity__input');
      if (qtyInput) {
        let value = parseInt(qtyInput.value) || 0;
        if (value < 0) {
          value = 0;
          qtyInput.value = value;
        }
      }
    }
    
    // Adjust quantity with optimistic update
    adjustQuantity(button, delta) {
      const wrapper = button.closest('[data-quantity-selector]');
      const input = wrapper.querySelector('.quantity__input');
      const currentQty = parseInt(input.value) || 0;
      const newQty = Math.max(0, currentQty + delta);
      
      // Optimistic UI update
      input.value = newQty;
      
      const key = input.getAttribute('data-update-cart');
      
      // Show immediate visual feedback
      if (CONFIG.optimisticUI) {
        this.optimisticUpdate(key, newQty, currentQty);
      }
      
      // Schedule the actual update with debouncing
      this.scheduleUpdate(key, newQty);
    }
    
    // Optimistic UI update - instant visual feedback
    optimisticUpdate(key, newQty, oldQty) {
      const row = this.getItemRow(key);
      if (!row) return;
      
      // Calculate expected totals locally
      if (state.lastCart && state.lastCart.items) {
        const item = state.lastCart.items.find(i => i.key === key);
        if (item) {
          const newLineTotal = item.final_price * newQty;
          const oldLineTotal = item.final_price * oldQty;
          const totalDiff = newLineTotal - oldLineTotal;
          
          // Update line total immediately
          const lineTotalEl = row.querySelector('[data-line-total]');
          if (lineTotalEl) {
            lineTotalEl.classList.add('price-updating');
            lineTotalEl.textContent = this.formatMoney(newLineTotal);
            setTimeout(() => lineTotalEl.classList.remove('price-updating'), 300);
          }
          
          // Update cart total immediately
          const cartFinalEl = document.querySelector('[data-cart-final]');
          if (cartFinalEl && state.lastCart.total_price !== undefined) {
            const newTotal = state.lastCart.total_price + totalDiff;
            cartFinalEl.classList.add('price-updating');
            cartFinalEl.textContent = this.formatMoney(newTotal);
            setTimeout(() => cartFinalEl.classList.remove('price-updating'), 300);
          }
        }
      }
      
      // Mark row as updating
      row.classList.add('updating');
    }
    
    // Schedule update with debouncing
    scheduleUpdate(key, quantity) {
      // Clear existing timer for this key
      if (state.debounceTimers.has(key)) {
        clearTimeout(state.debounceTimers.get(key));
      }
      
      // Store the latest quantity for this key
      state.pendingUpdates.set(key, quantity);
      
      // Set new debounce timer
      const timer = setTimeout(() => {
        this.processPendingUpdates();
      }, CONFIG.debounceDelay);
      
      state.debounceTimers.set(key, timer);
    }
    
    // Process all pending updates in batch
    async processPendingUpdates() {
      if (state.pendingUpdates.size === 0) return;
      if (state.isUpdating) {
        // Wait and retry
        setTimeout(() => this.processPendingUpdates(), 100);
        return;
      }
      
      const updates = new Map(state.pendingUpdates);
      state.pendingUpdates.clear();
      state.debounceTimers.clear();
      
      // Process updates
      if (CONFIG.batchUpdates && updates.size > 1) {
        await this.batchUpdate(updates);
      } else {
        // Single update
        const [key, quantity] = updates.entries().next().value;
        await this.updateCart(key, quantity);
      }
    }
    
    // Batch multiple updates into one request
    async batchUpdate(updates) {
      state.isUpdating = true;
      this.hideError();
      
      try {
        const updateObj = {};
        updates.forEach((quantity, key) => {
          updateObj[key] = quantity;
        });
        
        const response = await fetch('/cart/update.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ updates: updateObj })
        });
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const cart = await response.json();
        state.lastCart = cart;
        
        // Minimal refresh
        await this.smartRefresh(cart, Array.from(updates.keys()));
        
        this.dispatchCartEvent('success', cart);
        
      } catch (error) {
        console.error('Batch update error:', error);
        this.showError('Unable to update cart. Please try again.');
        this.revertOptimisticUpdates(updates);
      } finally {
        state.isUpdating = false;
      }
    }
    
    // Remove item with animation
    removeItem(key) {
      const row = this.getItemRow(key);
      if (row) {
        row.classList.add('removing');
        setTimeout(() => this.scheduleUpdate(key, 0), 300);
      } else {
        this.scheduleUpdate(key, 0);
      }
    }
    
    // Update cart via AJAX
    async updateCart(key, quantity) {
      state.isUpdating = true;
      this.hideError();
      
      const row = this.getItemRow(key);
      if (row) row.classList.add('updating');
      
      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ id: key, quantity: quantity })
        });
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const cart = await response.json();
        state.lastCart = cart;
        state.retryCount = 0;
        
        // Smart refresh - only update what changed
        await this.smartRefresh(cart, [key]);
        
        this.dispatchCartEvent('success', cart);
        
      } catch (error) {
        console.error('Cart update error:', error);
        this.showError('Unable to update cart. Please try again.');
        
        if (state.retryCount < CONFIG.maxRetries) {
          state.retryCount++;
          setTimeout(() => this.updateCart(key, quantity), 1000);
        } else {
          this.revertOptimisticUpdates(new Map([[key, quantity]]));
        }
        
      } finally {
        if (row) row.classList.remove('updating');
        state.isUpdating = false;
      }
    }
    
    // Smart refresh - only update changed elements
    async smartRefresh(cart, changedKeys) {
      // Handle empty cart
      if (cart.item_count === 0) {
        this.toggleEmptyCart(true);
        return;
      }
      
      // Update only changed items
      changedKeys.forEach(key => {
        const item = cart.items.find(i => i.key === key);
        const row = this.getItemRow(key);
        
        if (!item && row) {
          // Item was removed
          row.remove();
        } else if (item && row) {
          // Update item
          this.updateItemInDOM(item, row);
        }
      });
      
      // Update cart totals
      this.updateCartTotals(cart);
      
      // Update header cart
      this.updateHeaderCart(cart);
      
      // Update WCP if needed (with minimal delay)
      if (CONFIG.isWholesaleCustomer) {
        await this.updateWCP(cart);
      }
    }
    
    // Update individual item in DOM
    updateItemInDOM(item, row) {
      const formatter = this.getMoneyFormatter(item.currency);
      
      // Update quantity input
      const qtyInput = row.querySelector('[data-update-cart]');
      if (qtyInput && parseInt(qtyInput.value) !== item.quantity) {
        qtyInput.value = item.quantity;
      }
      
      // Update line total
      const lineTotalEl = row.querySelector('[data-line-total]');
      if (lineTotalEl) {
        lineTotalEl.textContent = formatter.format(item.final_line_price / 100);
      }
      
      // Update item price if needed
      const itemPriceEl = row.querySelector('[data-item-price]');
      if (itemPriceEl) {
        itemPriceEl.textContent = formatter.format(item.final_price / 100);
      }
    }
    
    // Update cart totals only
    updateCartTotals(cart) {
      const formatter = this.getMoneyFormatter(cart.currency);
      
      // Update subtotal
      const subtotalEl = document.querySelector('[data-cart-final]');
      if (subtotalEl) {
        subtotalEl.textContent = formatter.format(cart.total_price / 100);
      }
      
      // Update free shipping message
      this.updateFreeShippingMessage(cart);
    }
    
    // Update free shipping message
    updateFreeShippingMessage(cart) {
      const messageEl = document.querySelector('[data-cart-message]');
      if (!messageEl) return;
      
      const limit = parseInt(messageEl.getAttribute('data-limit')) || 0;
      const subtotal = cart.total_price / 100;
      
      if (subtotal >= limit) {
        messageEl.classList.add('is-success');
      } else {
        messageEl.classList.remove('is-success');
      }
      
      // Update progress circle
      const progressEl = messageEl.querySelector('[data-cart-progress]');
      if (progressEl) {
        let percent = Math.min(100, (subtotal / limit) * 100);
        const circumference = 87.96459430051421;
        const offset = circumference - (percent / 100 * circumference / 2);
        progressEl.style.strokeDashoffset = offset;
      }
      
      // Update amount left
      const leftEl = messageEl.querySelector('[data-left-to-spend]');
      if (leftEl && subtotal < limit) {
        const formatter = this.getMoneyFormatter(cart.currency);
        leftEl.textContent = formatter.format((limit - subtotal));
      }
    }
    
    // Update WCP wholesale pricing
    async updateWCP(cart) {
      if (!window.wcp_data) {
        await this.waitForWCP();
      }
      
      if (window.wcpRefreshCartTotal) {
        window.wcpRefreshCartTotal();
      }
      
      // Give WCP minimal time to update
      await new Promise(resolve => setTimeout(resolve, CONFIG.wcpDelay));
    }
    
    // Wait for WCP with timeout
    waitForWCP() {
      return new Promise((resolve) => {
        if (window.wcp_data) {
          resolve();
        } else {
          let elapsed = 0;
          const interval = 50;
          const checkInterval = setInterval(() => {
            elapsed += interval;
            if (window.wcp_data || elapsed > 3000) {
              clearInterval(checkInterval);
              resolve();
            }
          }, interval);
        }
      });
    }
    
    // Get item row element
    getItemRow(key) {
      const input = document.querySelector(`input[data-update-cart="${key}"]`);
      return input?.closest('[data-cart-item]');
    }
    
    // Revert optimistic updates on error
    revertOptimisticUpdates(updates) {
      // Reload to get correct state
      window.location.reload();
    }
    
    // Toggle empty cart state
    toggleEmptyCart(isEmpty) {
      if (isEmpty) {
        this.cartEmpty?.classList.remove('cart--hidden');
        this.cartForm?.closest('[data-cart-loading]')?.classList.add('cart--hidden');
      } else {
        this.cartEmpty?.classList.add('cart--hidden');
        this.cartForm?.closest('[data-cart-loading]')?.classList.remove('cart--hidden');
      }
    }
    
    // Update header cart
    updateHeaderCart(cart) {
      document.querySelectorAll('[data-header-cart-count], [data-cart-count-badge]').forEach(el => {
        el.textContent = cart.item_count;
        el.classList.toggle('hidden', cart.item_count === 0);
      });
      
      const formatter = this.getMoneyFormatter(cart.currency);
      document.querySelectorAll('[data-header-cart-price]').forEach(el => {
        el.textContent = formatter.format(cart.total_price / 100);
      });
    }
    
    // Get money formatter
    getMoneyFormatter(currency = 'USD') {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency
      });
    }
    
    // Format money helper
    formatMoney(cents, currency = 'USD') {
      return this.getMoneyFormatter(currency).format(cents / 100);
    }
    
    // Show error message
    showError(message) {
      if (this.errorContainer) {
        this.errorContainer.textContent = message;
        this.errorContainer.classList.add('active');
        setTimeout(() => this.hideError(), 5000);
      }
    }
    
    // Hide error message
    hideError() {
      this.errorContainer?.classList.remove('active');
    }
    
    // Prevent default form submission
    preventDefaultUpdate() {
      const updateButton = document.querySelector('[name="update"]');
      if (updateButton) {
        updateButton.addEventListener('click', (e) => {
          e.preventDefault();
          return false;
        });
      }
    }
    
    // Dispatch custom cart event
    dispatchCartEvent(type, cart) {
      document.dispatchEvent(new CustomEvent('theme:cart:change', {
        detail: { type, cart },
        bubbles: true
      }));
    }
  }
  
  // Initialize on DOM ready
  let cartManager;
  
  function initCartPage() {
    if (!cartManager) {
      cartManager = new CartManager();
    }
    cartManager.init();
  }
  
  window.initCartPage = initCartPage;
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCartPage);
  } else {
    initCartPage();
  }
  
  document.addEventListener('theme:cart:open', () => {
    setTimeout(initCartPage, 100);
  });
  
})();
</script>
            
{% schema %}
{
  "name": "Cart",
  "settings": [
    {
      "type": "select",
      "id": "bg",
      "label": "Background color",
      "default": "palette--light bg--neutral",
      "options": [
        { "value": "palette--light bg--neutral", "label": "Default"},
        { "value": "palette--light bg--accent", "label": "Light"},
        { "value": "palette--dark bg--invert", "label": "Dark"},
        { "value": "palette--dark bg--invert--accent", "label": "Dark accent"},
        { "value": "palette--bright bg--bright", "label": "Bright"},
        { "value": "palette--bright bg--bright--accent", "label": "Bright accent"}
      ]
    },
    {
      "type": "header",
      "content": "Section spacing"
    },
    {
      "type": "select",
      "id": "width",
      "label": "Width",
      "default": "wrapper",
      "options": [
        { "value": "wrapper--full", "label": "Full width padded" },
        { "value": "wrapper", "label": "Page width" },
        { "value": "wrapper--narrow", "label": "Page width narrow" }
      ]
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 180,
      "step": 2,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 180,
      "step": 2,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ]
}
{% endschema %}
